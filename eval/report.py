from __future__ import annotations
from datetime import datetime
import json
import pandas as pd

def _fmt_dict(d: dict) -> str:
    return "<pre>" + json.dumps(d, indent=2, default=float) + "</pre>"

def build_html_report(
    dataset_name: str,
    n_real: int, n_cols: int,
    model_name: str, settings: dict,
    fidelity: dict, utility: dict | None, privacy: dict,
) -> str:
    ts = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    headline = fidelity.get("headline", {})
    util_block = "" if utility is None else f"""
      <h3>Utility</h3>
      { _fmt_dict(utility) }
    """
    return f"""<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Tabular Synth Report — {dataset_name}</title>
<style>
 body {{ font-family: -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }}
 h1,h2,h3 {{ margin: 0.4rem 0; }}
 .card {{ border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }}
 code, pre {{ background:#111; color:#eee; padding:8px; border-radius:8px; overflow:auto; }}
 .grid {{ display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:12px; }}
 .small {{ color:#666; font-size: 0.9rem; }}
</style>
</head>
<body>
  <h1>Tabular Synth — Run Report</h1>
  <div class="small">{ts}</div>

  <div class="card">
    <h2>Overview</h2>
    <div class="grid">
      <div><strong>Dataset</strong><br/>{dataset_name}</div>
      <div><strong>Real rows</strong><br/>{n_real}</div>
      <div><strong>Columns</strong><br/>{n_cols}</div>
      <div><strong>Model</strong><br/>{model_name}</div>
    </div>
  </div>

  <div class="card">
    <h2>Settings</h2>
    {_fmt_dict(settings)}
  </div>

  <div class="card">
    <h2>Fidelity</h2>
    <div class="grid">
      <div><strong>Univariate OK %</strong><br/>{headline.get("univariate_ok_%"):.2f}</div>
      <div><strong>Median KS/TVD</strong><br/>{headline.get("median_KS_TVD"):.4f}</div>
      <div><strong>Median Corr Δ</strong><br/>{headline.get("median_corr_delta"):.4f}</div>
    </div>
    <h3>Univariate details</h3>
    {_fmt_dict({"univariate": fidelity.get("univariate", [])})}
    <h3>Correlation (worst)</h3>
    {_fmt_dict({"corr_worst": fidelity.get("corr_worst", [])})}
  </div>

  <div class="card">
    <h2>Privacy</h2>
    {_fmt_dict(privacy)}
  </div>

  <div class="card">
    {util_block}
  </div>

  <div class="small">Generated by Tabular Synth</div>
</body>
</html>
"""